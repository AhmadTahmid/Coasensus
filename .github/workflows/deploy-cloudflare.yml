name: Deploy Cloudflare

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' && secrets.CLOUDFLARE_ACCOUNT_ID != '' }}
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      TARGET_ENV: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Ensure DNS records for Pages domains
        shell: bash
        run: |
          set -euo pipefail
          API="https://api.cloudflare.com/client/v4"
          AUTH_HEADER="Authorization: Bearer ${CLOUDFLARE_API_TOKEN}"
          JSON_HEADER="Content-Type: application/json"

          zone_id="$(
            curl -sS \
              -H "${AUTH_HEADER}" \
              -H "${JSON_HEADER}" \
              "${API}/zones?name=coasensus.com&account.id=${CLOUDFLARE_ACCOUNT_ID}" \
            | jq -r '.result[0].id // empty'
          )"

          if [[ -z "${zone_id}" ]]; then
            echo "Unable to resolve zone id for coasensus.com"
            exit 1
          fi

          upsert_cname() {
            local fqdn="$1"
            local target="$2"

            local response
            response="$(
              curl -sS \
                -H "${AUTH_HEADER}" \
                -H "${JSON_HEADER}" \
                "${API}/zones/${zone_id}/dns_records?name=${fqdn}"
            )"

            local incompatible
            incompatible="$(echo "${response}" | jq -r '[.result[] | select(.type != "A" and .type != "AAAA" and .type != "CNAME")] | length')"
            if [[ "${incompatible}" != "0" ]]; then
              echo "Found incompatible existing DNS records for ${fqdn}; refusing automatic replacement."
              echo "${response}" | jq -r '.result[] | {id, type, name, content}'
              exit 1
            fi

            echo "${response}" | jq -c '.result[] | select(.type == "A" or .type == "AAAA")' | while read -r record; do
              id="$(echo "${record}" | jq -r '.id')"
              curl -sS -X DELETE \
                -H "${AUTH_HEADER}" \
                -H "${JSON_HEADER}" \
                "${API}/zones/${zone_id}/dns_records/${id}" \
              | jq -e '.success == true' > /dev/null
            done

            local cname_id
            cname_id="$(echo "${response}" | jq -r '.result[] | select(.type == "CNAME") | .id' | head -n1)"
            local payload
            payload="$(jq -n \
              --arg type "CNAME" \
              --arg name "${fqdn}" \
              --arg content "${target}" \
              '{type: $type, name: $name, content: $content, ttl: 1, proxied: true}')"

            if [[ -n "${cname_id}" ]]; then
              curl -sS -X PUT \
                -H "${AUTH_HEADER}" \
                -H "${JSON_HEADER}" \
                "${API}/zones/${zone_id}/dns_records/${cname_id}" \
                --data "${payload}" \
              | jq -e '.success == true' > /dev/null
            else
              curl -sS -X POST \
                -H "${AUTH_HEADER}" \
                -H "${JSON_HEADER}" \
                "${API}/zones/${zone_id}/dns_records" \
                --data "${payload}" \
              | jq -e '.success == true' > /dev/null
            fi
          }

          upsert_cname "coasensus.com" "coasensus-web.pages.dev"
          upsert_cname "staging.coasensus.com" "coasensus-web.pages.dev"

      - name: Apply D1 migrations
        run: npx wrangler d1 migrations apply coasensus-${{ env.TARGET_ENV }} --remote --config infra/cloudflare/wrangler.api.jsonc --env ${{ env.TARGET_ENV }}

      - name: Deploy API Worker
        run: npx wrangler deploy --config infra/cloudflare/wrangler.api.jsonc --env ${{ env.TARGET_ENV }}

      - name: Deploy Pages
        run: npx wrangler pages deploy apps/web/public --project-name coasensus-web --branch ${{ env.TARGET_ENV == 'production' && 'main' || 'staging' }}
